version: "3.8"
services:
  automation-hub:
    image: n8nio/n8n:latest
    container_name: automation-hub-n8n
    restart: unless-stopped

    # Security: Execution as non-root user (Standard 1000:1000 or via ENV)
    user: "${MY_ID:-1000}:${MY_GID:-1000}"
    ports:
      - "${N8N_PORT:-5678}:5678"

    environment:
      # --- Network & Identity ---
      - N8N_HOST=${N8N_HOST}
      - N8N_PORT=${N8N_PORT:-5678}
      - N8N_PROTOCOL=${N8N_PROTOCOL:-https}
      - WEBHOOK_URL=${WEBHOOK_URL}
      - NODE_ENV=production
      - GENERIC_TIMEZONE=${TZ:-Europe/Madrid}
      - TZ=${TZ:-Europe/Madrid}

      # --- Security & Hardening ---
      - N8N_ENFORCE_SETTINGS_FILE_PERMISSIONS=true
      - N8N_SECURE_COOKIE=true
      - N8N_TRUST_PROXY=true
      - N8N_TASK_RUNNERS_ENABLED=false
      - N8N_BLOCK_NODES=${N8N_BLOCK_NODES:-}

      # --- Observability & Error Handling ---
      - N8N_DEFAULT_ERROR_WORKFLOW_ID=${ERROR_WORKFLOW_ID}

      # --- Performance & Persistence Optimization ---
      - EXECUTIONS_DATA_PRUNE=${EXECUTIONS_DATA_PRUNE:-true}
      - EXECUTIONS_DATA_PRUNE_MAX_COUNT=${EXECUTIONS_DATA_PRUNE_MAX_COUNT:-50}
      - EXECUTIONS_DATA_MAX_AGE=${EXECUTIONS_DATA_MAX_AGE:-168}
      - EXECUTIONS_DATA_SAVE_ON_ERROR=${EXECUTIONS_DATA_SAVE_ON_ERROR:-all}
      - EXECUTIONS_DATA_SAVE_ON_SUCCESS=${EXECUTIONS_DATA_SAVE_ON_SUCCESS:-none}
      - DB_SQLITE_VACUUM_ON_STARTUP=true

    # Reliability: Resource limits to prevent host exhaustion
    deploy:
      resources:
        limits:
          cpus: '0.50'
          memory: 1G

    volumes:
      - ${N8N_DATA_PATH:-./n8n_data}:/home/node/.n8n

networks:
  default:
    name: automation_network
